<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ç‹åœ‹è»å¸«çš„ä½œæˆ°ç¸½éƒ¨ - DQ Style v4.9</title>
    
    <script src="https://accounts.google.com/gsi/client" async defer></script>
    
    <style>
        @import url('https://fonts.googleapis.com/css2?family=DotGothic16&display=swap');
        
        body {
            font-family: 'DotGothic16', monospace; background-color: #000; color: #ffffff; 
            margin: 0; padding: 20px; display: flex; flex-direction: column;
            align-items: center; min-height: 100vh; justify-content: center;
        }
        
        .dq-window {
            background-color: #000000; border: 4px solid #ffffff; border-radius: 8px;
            padding: 20px; box-shadow: inset 0 0 0 2px #000, inset 0 0 0 4px #fff; 
            width: 100%; max-width: 800px; margin-bottom: 20px; box-sizing: border-box;
        }

        h1, h2, h3 { margin-top: 0; text-align: center; letter-spacing: 2px; color: #ffff00; text-shadow: 2px 2px 0px #aa5500; }
        
        /* å…¥å£ç•«é¢ */
        #intro-screen { text-align: center; width: 100%; max-width: 600px; transition: opacity 1s ease-in-out; }
        .title-logo { font-size: 36px; color: #ffff00; margin-bottom: 40px; line-height: 1.5; text-shadow: 3px 3px 0px #aa5500; }
        .scene-container { position: relative; height: 160px; margin: 40px 0; border-bottom: 4px dashed #555; overflow: hidden; }
        
        #hero-img { position: absolute; left: 10%; bottom: 10px; transition: left 2s linear, opacity 0.5s ease; z-index: 2; }
        #castle-img { position: absolute; right: 10%; bottom: 10px; z-index: 1; }

        .start-btn {
            background-color: transparent; color: #fff; border: 2px dashed #fff; padding: 15px 30px;
            font-family: 'DotGothic16', monospace; font-size: 24px; cursor: pointer; margin-top: 20px; animation: blink 1.5s infinite;
        }
        .start-btn:hover { background-color: #fff; color: #000; animation: none; }
        @keyframes blink { 0%, 100% { opacity: 1; } 50% { opacity: 0.3; } }

        /* ä¸»ç•«é¢ */
        #game-ui { display: none; opacity: 0; transition: opacity 1.5s ease-in-out; width: 100%; max-width: 800px; flex-direction: column; align-items: center; }
        
        /* === ç©å®¶è³‡è¨Šåˆ— === */
        .player-profile { display: flex; align-items: center; justify-content: space-between; border-bottom: 2px dashed #555; padding-bottom: 10px; margin-bottom: 15px; }
        .player-info { display: flex; align-items: center; gap: 10px; }
        .player-info img { width: 32px; height: 32px; border-radius: 50%; border: 2px solid #ffff00; }
        .player-name { color: #55ffff; font-size: 1.2em; }
        
        .status-bar { display: flex; justify-content: space-around; font-size: 1.2em; margin-bottom: 10px; border-bottom: 2px dashed #ffffff; padding-bottom: 15px; width: 100%; }
        label { display: block; margin-top: 15px; font-size: 1.1em; color: #55ffff; text-align: left;}
        input[type="text"], textarea { width: 100%; background: transparent; color: #ffffff; border: none; border-bottom: 2px solid #555; font-family: 'DotGothic16', monospace; padding: 5px; margin-top: 5px; font-size: 18px; box-sizing: border-box; }
        input:focus, textarea:focus { outline: none; border-bottom: 2px solid #ffff00; }
        .checkbox-group { margin-top: 10px; padding-left: 10px; text-align: left;}
        .checkbox-item { display: flex; align-items: center; margin-bottom: 5px; }
        .checkbox-item input[type="checkbox"] { transform: scale(1.5); margin-right: 15px; }
        .btn { background-color: #000; color: #fff; border: 2px solid #fff; border-radius: 4px; padding: 12px; font-family: 'DotGothic16', monospace; font-size: 18px; cursor: pointer; width: 100%; margin-top: 10px; text-align: left; transition: 0.1s; }
        .btn::before { content: 'ã€€ã€€'; }
        .btn:hover { border-color: #ffff00; color: #ffff00; }
        .btn:hover::before { content: 'â–¶ '; }
        .btn-rest { color: #55ffff; border-color: #55ffff; }
        .btn-success { color: #ffff00; border-color: #ffff00; }
        .btn-danger { color: #ff5555; border-color: #ff5555; }
        .btn-small { background-color: transparent; color: #888; border: 1px dashed #888; padding: 5px 10px; font-family: 'DotGothic16', monospace; font-size: 14px; cursor: pointer; transition: 0.2s; }
        .btn-small:hover { color: #fff; border-color: #fff; }
        #timer-display { font-size: 80px; text-align: center; margin: 10px 0; letter-spacing: 5px; color: #ffffff; }
        .history-board { max-height: 300px; overflow-y: auto; padding-right: 10px; text-align: left; }
        .history-item { margin-bottom: 15px; padding-bottom: 15px; border-bottom: 1px dashed #555; }
        .history-header { display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 5px; }
        .history-item .timestamp { color: #888; font-size: 0.9em; }
        .history-item .title { color: #ffff00; font-size: 1.1em; margin-bottom: 5px; }
        .btn-delete { color: #ff5555; border-color: #555; font-size: 12px; padding: 2px 8px; }
        .btn-delete:hover { color: #ff0000; border-color: #ff0000; background-color: rgba(255,0,0,0.1); }
        .clear-all-btn { display: block; width: 100%; text-align: center; margin-top: 15px; border-top: 1px dashed #555; padding-top: 15px; }
    </style>
</head>
<body>

    <div id="intro-screen" class="dq-window">
        <div class="title-logo">
            âš”ï¸ ç‹åœ‹è»å¸«ä½œæˆ°ç¸½éƒ¨<br>
            <span style="font-size: 24px; color: #888;">CORE CITY</span>
        </div>
        
        <div id="g_id_onload"
             data-client_id="777879557726-kjm4c6nlt9ibpi5mjk0uuvuqja3uisf1.apps.googleusercontent.com"
             data-context="signin"
             data-ux_mode="popup"
             data-callback="handleCredentialResponse"
             data-auto_prompt="false">
        </div>
        <div style="display: flex; justify-content: center; margin-bottom: 20px;">
            <div class="g_id_signin" data-type="standard" data-shape="rectangular" data-theme="filled_black" data-text="signin_with" data-size="large" data-logo_alignment="left"></div>
        </div>
        <div class="scene-container">
            <svg id="hero-img" viewBox="0 0 32 32" width="80" height="80">
                <rect x="12" y="14" width="8" height="10" fill="#cc0000" /><rect x="10" y="4" width="12" height="10" fill="#aaaaaa" /><rect x="12" y="8" width="8" height="2" fill="#222222" /><rect x="14" y="2" width="4" height="2" fill="#d4af37" /><rect x="15" y="0" width="2" height="2" fill="#ff0000" /><rect x="22" y="10" width="2" height="14" fill="#eeeeee" /><rect x="20" y="20" width="6" height="2" fill="#d4af37" /><path d="M 6 12 L 12 12 L 12 20 L 9 24 L 6 20 Z" fill="#2266cc" /><rect x="12" y="24" width="3" height="6" fill="#777777" /><rect x="17" y="24" width="3" height="6" fill="#777777" />
            </svg>
            <svg id="castle-img" viewBox="0 0 40 40" width="120" height="120">
                <rect x="5" y="20" width="30" height="20" fill="#666666" /><rect x="2" y="10" width="10" height="30" fill="#555555" /><rect x="28" y="10" width="10" height="30" fill="#555555" /><rect x="1" y="8" width="3" height="4" fill="#555555" /><rect x="5" y="8" width="4" height="4" fill="#555555" /><rect x="10" y="8" width="3" height="4" fill="#555555" /><rect x="27" y="8" width="3" height="4" fill="#555555" /><rect x="31" y="8" width="4" height="4" fill="#555555" /><rect x="36" y="8" width="3" height="4" fill="#555555" /><path d="M 16 40 L 16 25 A 4 4 0 0 1 24 25 L 24 40 Z" fill="#332211" /><rect x="5" y="15" width="4" height="6" fill="#222222" rx="2" /><rect x="31" y="15" width="4" height="6" fill="#222222" rx="2" />
            </svg>
        </div>
        <button id="start-intro-btn" class="start-btn" onclick="enterCastle()">â–¶ é–‹å§‹ä»»å‹™ (PRESS START)</button>
    </div>

    <div id="game-ui">
        <div class="dq-window">
            
            <div class="player-profile" id="player-profile-ui" style="display: none;">
                <div class="player-info">
                    <img id="player-avatar" src="" alt="Avatar">
                    <span class="player-name">è»å¸« <span id="player-name"></span>ï¼Œæ­¡è¿æ­¸ä¾†ï¼</span>
                </div>
                <button class="btn-small" onclick="signOut()">ç™»å‡ºç¥æ®¿</button>
            </div>

            <h1>âš”ï¸ ä½œæˆ°ç¸½éƒ¨å…§éƒ¨</h1>
            <div class="status-bar">
                <span>EXP: <span id="exp-val">0</span></span>
                <span>è¨ä¼æˆåŠŸ: <span id="pomodoro-count">0</span> å›</span>
            </div>
            
            <div id="scroll-ui">
                <h3>ã€ ä¸‹é”ä½œæˆ°æŒ‡ä»¤ ã€‘</h3>
                <label>ğŸ¯ è¨ä¼ç›®æ¨™ (Target)ï¼š</label>
                <input type="text" id="quest-target" placeholder="ä¾‹ï¼šèŠ±è“®ç¾¤å‹Ÿè¨ˆç•« - å¾µé¸ç°¡ç« è©•åˆ†æ¨™æº–æ’°å¯«">
                <label>ğŸ‘ï¸ æ•µæ–¹æƒ…å ± (å›°é›£é»/å¡é—œåŸå› )ï¼š</label>
                <textarea id="quest-problem" rows="2" placeholder="ç°¡ç« è‰ç¨¿æœ‰äº†ï¼Œä½†è©•åˆ†æ¬Šé‡å¤ªæ¨¡ç³Š..."></textarea>
                <label>ğŸ—ºï¸ è¡Œå‹•æŒ‡ä»¤ (æ‹†è§£æˆ 3 æ­¥å…·é«”æ‰“æ“Šå‹•ä½œ)ï¼š</label>
                <div class="checkbox-group">
                    <div class="checkbox-item"><input type="checkbox"><input type="text" placeholder="è© å”±ï¼šèª¿é–±å»å¹´æ–°ç«¹å¸‚ç°¡ç« åƒè€ƒ"></div>
                    <div class="checkbox-item"><input type="checkbox"><input type="text" placeholder="æœƒå¿ƒä¸€æ“Šï¼šåˆ—å‡º 3 å€‹åœ¨åœ°æ ¸å¿ƒ KPI"></div>
                    <div class="checkbox-item"><input type="checkbox"><input type="text" placeholder="å°å°ï¼šå°‡ç™¾åˆ†æ¯”å¡«å…¥ Word è‰ç¨¿"></div>
                </div>
                <label>âœ¨ ç¥ˆç¦±èˆ‡èª“è¨€ (ä½ æƒ³ç²å¾—ä»€éº¼æ¨‚è¶£ï¼Ÿ)ï¼š</label>
                <input type="text" placeholder="å»ºç«‹ç„¡æ•µå…¬ç‰ˆï¼Œä»¥å¾Œæ¨™æ¡ˆç›´æ¥æ”¾é­”æ³•è¼•é¬†éé—œï¼">
            </div>
            <div id="timer-display">25:00</div>
            <button class="btn-small" style="margin: 0 auto; display: block;" onclick="playRetroSound()">ğŸ”Š æ¸¬è©¦å‡ç´šéŸ³æ•ˆ</button>
            <div id="action-buttons" style="margin-top: 15px;">
                <div id="idle-btns">
                    <button class="btn" onclick="startWork()">è£å‚™æŒ‡ä»¤ï¼Œé€²å…¥ 25 åˆ†é˜æˆ°é¬¥</button>
                    <button class="btn btn-rest" onclick="startRest()">ç›´æ¥å‰å¾€æ—…åº— ( 5 åˆ†é˜ä¼‘æ¯ )</button>
                </div>
                <div id="working-btns" style="display:none;">
                    <button class="btn btn-success" onclick="finishWork(true)">ææ—©æ“Šæ®ºï¼(ææ—©å®Œæˆä¸¦å¯«æˆ°å ±)</button>
                    <button class="btn btn-danger" onclick="finishWork(false)">é­é‡å¼·æ•µï¼(æ”¾æ£„ä»»å‹™ä¸¦é€ƒè·‘)</button>
                </div>
                <div id="resting-btns" style="display:none;">
                    <button class="btn" onclick="finishRest()">é«”åŠ›å·²æ»¿ï¼Œææ—©çµæŸä¼‘æ¯</button>
                </div>
            </div>
        </div>
        
        <div class="dq-window" style="width: 100%;">
            <h2>ğŸ“œ å†’éšªä¹‹æ›¸ (Save Data)</h2>
            <div class="history-board" id="history-list"></div>
            <div class="clear-all-btn">
                <button class="btn-small btn-delete" onclick="clearAllHistory()">ğŸ”¥ ç„šæ¯€æ•´æœ¬å†’éšªä¹‹æ›¸ (æ¸…é™¤å…¨éƒ¨ç´€éŒ„)</button>
            </div>
        </div>
    </div>

    <script>
        // ================= Google ç™»å…¥é‚è¼¯ =================
        function handleCredentialResponse(response) {
            // è§£æ Google å‚³å›ä¾†çš„ JWT Tokenï¼Œæ‹¿åˆ°åå­—å’Œé ­åƒ
            const responsePayload = decodeJwtResponse(response.credential);
            console.log("ç™»å…¥æˆåŠŸï¼ä½¿ç”¨è€…ï¼š", responsePayload.name);
            
            // é¡¯ç¤ºç©å®¶é ­åƒè·Ÿåå­—
            document.getElementById('player-name').innerText = responsePayload.name;
            document.getElementById('player-avatar').src = responsePayload.picture;
            document.getElementById('player-profile-ui').style.display = 'flex';
            
            // éš±è—ç™»å…¥æŒ‰éˆ•
            document.querySelector('.g_id_signin').style.display = 'none';
            alert("âš”ï¸ é€£çµç¥æ®¿æˆåŠŸï¼æ­¡è¿æ­¸ä¾†ï¼Œ" + responsePayload.name + "ï¼");
        }

        // è§£æ JWT çš„è¼”åŠ©å‡½æ•¸
        function decodeJwtResponse(token) {
            let base64Url = token.split('.')[1];
            let base64 = base64Url.replace(/-/g, '+').replace(/_/g, '/');
            let jsonPayload = decodeURIComponent(window.atob(base64).split('').map(function(c) {
                return '%' + ('00' + c.charCodeAt(0).toString(16)).slice(-2);
            }).join(''));
            return JSON.parse(jsonPayload);
        }

        function signOut() {
            document.getElementById('player-profile-ui').style.display = 'none';
            document.querySelector('.g_id_signin').style.display = 'block';
            alert("å·²ç™»å‡ºç¥æ®¿é€£ç·šã€‚");
        }

        // ================= éŠæˆ²æ ¸å¿ƒé‚è¼¯ =================
        function enterCastle() {
            playRetroSound();
            document.getElementById('start-intro-btn').style.display = 'none';
            document.getElementById('hero-img').style.left = '75%';
            setTimeout(() => { document.getElementById('hero-img').style.opacity = '0'; }, 2000);
            setTimeout(() => {
                document.getElementById('intro-screen').style.opacity = '0'; 
                setTimeout(() => {
                    document.getElementById('intro-screen').style.display = 'none'; 
                    const gameUI = document.getElementById('game-ui');
                    gameUI.style.display = 'flex';      
                    void gameUI.offsetWidth; 
                    gameUI.style.opacity = '1';
                }, 1000); 
            }, 2500);
        }

        const WORK_TIME = 25 * 60; const REST_TIME = 5 * 60;  
        let timerInterval; let timeLeft = WORK_TIME; let currentState = 'IDLE'; 
        let exp = parseInt(localStorage.getItem('dqCityExp')) || 0;
        let pomodoros = parseInt(localStorage.getItem('dqCityPomodoros')) || 0;
        document.getElementById('exp-val').innerText = exp; document.getElementById('pomodoro-count').innerText = pomodoros;
        loadHistory(); updateDisplay();

        function playRetroSound() {
            const ctx = new (window.AudioContext || window.webkitAudioContext)(); if (!ctx) return;
            const osc = ctx.createOscillator(); const gainNode = ctx.createGain(); osc.type = 'square'; 
            osc.frequency.setValueAtTime(523.25, ctx.currentTime); osc.frequency.setValueAtTime(659.25, ctx.currentTime + 0.1); 
            osc.frequency.setValueAtTime(783.99, ctx.currentTime + 0.2); osc.frequency.setValueAtTime(1046.50, ctx.currentTime + 0.3); 
            gainNode.gain.setValueAtTime(0.1, ctx.currentTime); gainNode.gain.exponentialRampToValueAtTime(0.001, ctx.currentTime + 0.6);
            osc.connect(gainNode); gainNode.connect(ctx.destination); osc.start(); osc.stop(ctx.currentTime + 0.6);
        }

        function updateDisplay() {
            let m = Math.floor(timeLeft / 60); let s = timeLeft % 60;
            document.getElementById('timer-display').innerText = (m < 10 ? '0' + m : m) + ':' + (s < 10 ? '0' + s : s);
        }

        function switchUI(state) {
            document.getElementById('idle-btns').style.display = (state === 'IDLE') ? 'block' : 'none';
            document.getElementById('working-btns').style.display = (state === 'WORKING') ? 'block' : 'none';
            document.getElementById('resting-btns').style.display = (state === 'RESTING') ? 'block' : 'none';
            const scrollUI = document.getElementById('scroll-ui');
            if (state === 'WORKING' || state === 'RESTING') { scrollUI.style.opacity = '0.4'; scrollUI.style.pointerEvents = 'none'; } 
            else { scrollUI.style.opacity = '1'; scrollUI.style.pointerEvents = 'auto'; }
        }

        function startWork() {
            const t = document.getElementById('quest-target').value; const p = document.getElementById('quest-problem').value;
            if(t.trim() === '' || p.trim() === '') { alert('âš ï¸ å‡ºç™¼å‰è«‹å¯«ä¸‹ã€Œè¨ä¼ç›®æ¨™ã€èˆ‡ã€Œæ•µæ–¹æƒ…å ±ã€ï¼'); return; }
            currentState = 'WORKING'; timeLeft = WORK_TIME; switchUI('WORKING'); runTimer('WORK');
        }

        function finishWork(isSuccess) {
            clearInterval(timerInterval);
            if (isSuccess) {
                playRetroSound();
                setTimeout(() => {
                    let r = prompt("ğŸµ å‡ç´šï¼å¯«ä¸‹ã€æˆ°æœèˆ‡ä¸‹ä¸€æ­¥ã€‘ï¼š"); if(!r) r = "æœªç•™ä¸‹æˆ°åˆ©å“ç´€éŒ„ã€‚";
                    exp += 150; pomodoros += 1;
                    localStorage.setItem('dqCityExp', exp); localStorage.setItem('dqCityPomodoros', pomodoros);
                    document.getElementById('exp-val').innerText = exp; document.getElementById('pomodoro-count').innerText = pomodoros;
                    saveReport(document.getElementById('quest-target').value, document.getElementById('quest-problem').value, r);
                    document.querySelectorAll('input[type="text"], textarea').forEach(el => el.value = '');
                    document.querySelectorAll('input[type="checkbox"]').forEach(el => el.checked = false);
                    resetToIdle();
                }, 100); 
            } else { if(confirm('ç¢ºå®šè¦é€ƒè·‘å—ï¼Ÿ')) { resetToIdle(); } else { runTimer('WORK'); } }
        }

        function startRest() { currentState = 'RESTING'; timeLeft = REST_TIME; switchUI('RESTING'); runTimer('REST'); }
        function finishRest() { clearInterval(timerInterval); alert('ğŸ”” ä¼‘æ¯çµæŸï¼HPå·²æ¢å¾©ã€‚'); resetToIdle(); }
        function runTimer(mode) {
            timerInterval = setInterval(() => { timeLeft--; updateDisplay();
                if(timeLeft <= 0) { clearInterval(timerInterval); if (mode === 'WORK') { finishWork(true); } else { playRetroSound(); setTimeout(() => finishRest(), 100); } }
            }, 1000);
        }
        function resetToIdle() { currentState = 'IDLE'; timeLeft = WORK_TIME; updateDisplay(); switchUI('IDLE'); }

        // --- å­˜æª”ç®¡ç† ---
        function saveReport(t, p, r) {
            const now = new Date(); const timeString = `${now.getMonth()+1}/${now.getDate()} ${now.getHours().toString().padStart(2, '0')}:${now.getMinutes().toString().padStart(2, '0')}`;
            const record = { time: timeString, target: t, problem: p, report: r };
            let h = JSON.parse(localStorage.getItem('dqCityHistory')) || []; h.unshift(record); 
            localStorage.setItem('dqCityHistory', JSON.stringify(h)); loadHistory();
        }
        function deleteRecord(idx) {
            if(confirm('æŠ¹æ¶ˆé€™ç­†æˆ°å ±ï¼Ÿ')) { let h = JSON.parse(localStorage.getItem('dqCityHistory')) || []; h.splice(idx, 1); localStorage.setItem('dqCityHistory', JSON.stringify(h)); loadHistory(); }
        }
        function clearAllHistory() { if(confirm('ğŸ”¥ è­¦å‘Šï¼šç„šæ¯€æ•´æœ¬å†’éšªä¹‹æ›¸ï¼Ÿ')) { localStorage.removeItem('dqCityHistory'); loadHistory(); } }
        function loadHistory() {
            const list = document.getElementById('history-list'); list.innerHTML = '';
            let h = JSON.parse(localStorage.getItem('dqCityHistory')) || [];
            if(h.length === 0) { list.innerHTML = '<div style="color:#aaa;">å†’éšªä¹‹æ›¸ç©ºç™½ä¸­...</div>'; return; }
            h.forEach((item, idx) => {
                const div = document.createElement('div'); div.className = 'history-item';
                div.innerHTML = `<div class="history-header"><span class="timestamp">[${item.time}]</span><button class="btn-small btn-delete" onclick="deleteRecord(${idx})">âœ–</button></div>
                    <div class="title">è¨ä¼ï¼š${item.target}</div><div style="color:#55ffff;">æƒ…å ±ï¼š${item.problem}</div><div style="color:#ffffff;">â” æˆ°æœï¼š${item.report}</div>`;
                list.appendChild(div);
            });
        }
    </script>
</body>
</html>
