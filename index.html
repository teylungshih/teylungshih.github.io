<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>The Jazz Journey - çˆµå£«å¤§å¸«ä¹‹è·¯ v5.2</title>
    
    <script src="https://accounts.google.com/gsi/client" async defer></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=DotGothic16&display=swap');
        
        body {
            font-family: 'DotGothic16', monospace;
            background-color: #000c18;
            background-image: radial-gradient(circle at 50% 30%, #0f2040 0%, #000c18 70%);
            color: #e0c097;
            margin: 0; padding: 20px; display: flex; flex-direction: column;
            align-items: center; min-height: 100vh; justify-content: center;
        }
        
        .jazz-window {
            background-color: #000000; border: 4px solid #d4af37;
            border-radius: 8px; padding: 20px;
            box-shadow: inset 0 0 0 2px #000, inset 0 0 0 4px #d4af37; 
            width: 100%; max-width: 800px; margin-bottom: 20px; box-sizing: border-box;
        }

        h1, h2, h3 { 
            margin-top: 0; text-align: center; letter-spacing: 2px;
            color: #ffff00; text-shadow: 2px 2px 0px #aa5500;
        }
        
        #intro-screen { text-align: center; width: 100%; max-width: 600px; transition: opacity 1s ease-in-out; }
        .title-logo { font-size: 36px; color: #ffff00; margin-bottom: 40px; line-height: 1.5; text-shadow: 3px 3px 0px #aa5500; }
        .scene-container { position: relative; height: 160px; margin: 40px 0; border-bottom: 4px dashed #555; overflow: hidden; }
        
        #musician-img { position: absolute; left: 10%; bottom: 10px; transition: left 2.5s ease-in-out, opacity 0.5s ease; z-index: 2; }
        #stage-img { position: absolute; right: 15%; bottom: 10px; z-index: 1; }

        .start-btn {
            background-color: transparent; color: #fff; border: 2px dashed #fff; padding: 15px 30px;
            font-family: 'DotGothic16', monospace; font-size: 24px; cursor: pointer; margin-top: 20px; animation: blink 1.5s infinite;
        }
        .start-btn:hover { background-color: #fff; color: #000; animation: none; }
        @keyframes blink { 0%, 100% { opacity: 1; } 50% { opacity: 0.3; } }

        #game-ui { display: none; opacity: 0; transition: opacity 1.5s ease-in-out; width: 100%; max-width: 800px; flex-direction: column; align-items: center; }
        .player-profile { display: flex; align-items: center; justify-content: space-between; border-bottom: 2px dashed #555; padding-bottom: 10px; margin-bottom: 15px; }
        .player-info { display: flex; align-items: center; gap: 10px; }
        .player-info img { width: 32px; height: 32px; border-radius: 50%; border: 2px solid #ffff00; }
        .player-name { color: #55ffff; font-size: 1.2em; }
        .status-bar { display: flex; justify-content: space-around; font-size: 1.2em; margin-bottom: 10px; border-bottom: 2px dashed #ffffff; padding-bottom: 15px; width: 100%; }
        
        label { display: block; margin-top: 15px; font-size: 1.1em; color: #55ffff; text-align: left;}
        input[type="text"], textarea {
            width: 100%; background: transparent; color: #ffffff; border: none; border-bottom: 2px solid #555;
            font-family: 'DotGothic16', monospace; padding: 5px; margin-top: 5px; font-size: 18px; box-sizing: border-box;
        }
        input:focus, textarea:focus { outline: none; border-bottom: 2px solid #ffff00; }
        
        .checkbox-group { margin-top: 10px; padding-left: 10px; text-align: left;}
        .checkbox-item { display: flex; align-items: center; margin-bottom: 5px; }
        .checkbox-item input[type="checkbox"] { transform: scale(1.5); margin-right: 15px; }
        
        .btn {
            background-color: #000; color: #fff; border: 2px solid #fff; border-radius: 4px; padding: 12px; 
            font-family: 'DotGothic16', monospace; font-size: 18px; cursor: pointer; width: 100%; margin-top: 10px;
            text-align: left; transition: 0.1s;
        }
        .btn::before { content: 'ã€€ã€€'; }
        .btn:hover { border-color: #ffff00; color: #ffff00; }
        .btn:hover::before { content: 'â–¶ '; }
        
        .btn-rest { color: #55ffff; border-color: #55ffff; }
        .btn-success { color: #ffff00; border-color: #ffff00; }
        .btn-danger { color: #ff5555; border-color: #ff5555; }
        .btn-small { background-color: transparent; color: #888; border: 1px dashed #888; padding: 5px 10px; font-family: 'DotGothic16', monospace; font-size: 14px; cursor: pointer; transition: 0.2s; }
        .btn-small:hover { color: #fff; border-color: #fff; }
        
        #timer-display { font-size: 80px; text-align: center; margin: 10px 0; letter-spacing: 5px; color: #ffffff; }
        
        .history-board { max-height: 300px; overflow-y: auto; padding-right: 10px; text-align: left; }
        .history-item { margin-bottom: 15px; padding-bottom: 15px; border-bottom: 1px dashed #555; }
        .history-header { display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 5px; }
        .history-item .timestamp { color: #888; font-size: 0.9em; }
        .history-item .title { color: #ffff00; font-size: 1.1em; margin-bottom: 5px; }
    </style>
</head>
<body>

    <div id="intro-screen" class="jazz-window">
        <div class="title-logo">
            THE JAZZ JOURNEY<br>
            <span style="font-size: 24px; color: #888;">è·¯æ˜“æ–¯å¤§å¸«ä¹‹åŠ</span>
        </div>
        
        <div id="g_id_onload"
             data-client_id="777879557726-kjm4c6nlt9ibpi5mjk0uuvuqja3uisf1.apps.googleusercontent.com"
             data-context="signin"
             data-ux_mode="popup"
             data-callback="handleCredentialResponse"
             data-auto_prompt="false">
        </div>
        <div style="display: flex; justify-content: center; margin-bottom: 20px;">
            <div class="g_id_signin" data-type="standard" data-shape="rectangular" data-theme="filled_black" data-text="signin_with" data-size="large" data-logo_alignment="left"></div>
        </div>

        <div class="scene-container">
            <svg id="musician-img" viewBox="0 0 32 32" width="80" height="80">
                <rect x="12" y="14" width="8" height="10" fill="#222" />
                <rect x="11" y="4" width="10" height="10" fill="#4d3319" />
                <rect x="12" y="10" width="8" height="2" fill="#000" />
                <rect x="18" y="12" width="12" height="2" fill="#d4af37" /> 
                <rect x="28" y="10" width="2" height="6" fill="#d4af37" />
                <rect x="12" y="24" width="3" height="6" fill="#111" />
                <rect x="17" y="24" width="3" height="6" fill="#111" />
            </svg>
            <svg id="stage-img" viewBox="0 0 40 40" width="100" height="100">
                <rect x="18" y="10" width="4" height="30" fill="#555" />
                <circle cx="20" cy="8" r="4" fill="#aaa" />
                <rect x="12" y="38" width="16" height="2" fill="#333" />
            </svg>
        </div>
        <button id="start-intro-btn" class="start-btn" onclick="enterStage()">â–¶ ä¸‹é”æ¼”å‡ºæŒ‡ä»¤</button>
    </div>

    <div id="game-ui">
        <div class="jazz-window">
            <div class="player-profile" id="player-profile-ui" style="display: none;">
                <div class="player-info">
                    <img id="player-avatar" src="" alt="Avatar">
                    <span class="player-name">å¤§å¸« <span id="player-name"></span>ï¼Œæ­¡è¿æ­¸ä¾†ï¼</span>
                </div>
                <button class="btn-small" onclick="signOut()">ç™»å‡ºç¥æ®¿</button>
            </div>

            <h1>ğŸ· çˆµå£«æ¨‚å¾Œå°</h1>
            <div class="status-bar">
                <span>Groove: <span id="exp-val" style="color:#ffff00;">0</span></span>
                <span>æ¼”å‡ºæˆåŠŸ: <span id="pomodoro-count" style="color:#ffff00;">0</span> å›</span>
            </div>
            
            <div id="scroll-ui">
                <h3>ã€ ä¸‹é”æ¼”å‡ºæŒ‡ä»¤ ã€‘</h3>
                <label>ğŸ¯ æœ¬æ¬¡æ›²ç›®ç›®æ¨™ (The Standard)ï¼š</label>
                <input type="text" id="quest-target" placeholder="ä¾‹ï¼šèŠ±è“®ç¾¤å‹Ÿè¨ˆç•« - æ’°å¯«è©•åˆ†æ¨™æº–">
                <label>ğŸ‘ï¸ ç·´ç¿’ç“¶é ¸ (The Shed Struggle)ï¼š</label>
                <textarea id="quest-problem" rows="2" placeholder="ç›®å‰çš„æ¬Šé‡å®šç¾©å¤ªæ¨¡ç³Š..."></textarea>
                <label>ğŸ¹ å³èˆˆæ¨‚å¥ç·´ç¿’ (Action Riffs)ï¼š</label>
                <div class="checkbox-group">
                    <div class="checkbox-item"><input type="checkbox"><input type="text" placeholder="æ¡è­œï¼šåƒè€ƒå»å¹´çš„æ–°ç«¹å¸‚ç°¡ç« "></div>
                    <div class="checkbox-item"><input type="checkbox"><input type="text" placeholder="çˆ¬éŸ³éšï¼šåˆ—å‡º 3 å€‹åœ¨åœ°æ ¸å¿ƒ KPI"></div>
                    <div class="checkbox-item"><input type="checkbox"><input type="text" placeholder="åˆå¥ï¼šå°‡ç™¾åˆ†æ¯”å¡«å…¥è¡¨æ ¼"></div>
                </div>
                <label>âœ¨ éˆæ„Ÿèˆ‡äº«å— (The Muse)ï¼š</label>
                <input type="text" placeholder="å¯«å‡ºå®Œç¾çš„å…¬ç‰ˆï¼Œä»¥å¾Œéƒ½èƒ½è¼•é¬†å³èˆˆï¼">
            </div>

            <div id="timer-display">25:00</div>
            <button class="btn-small" style="margin: 0 auto; display: block; border-color:#d4af37; color:#d4af37;" onclick="playTheLick()">ğŸ¹ è©¦éŸ³ (The Lick)</button>
            
            <div id="action-buttons" style="margin-top: 15px;">
                <div id="idle-btns">
                    <button class="btn" style="color:#ffff00; border-color:#ffff00;" onclick="startWork()">Showtime! é€²å…¥ 25 åˆ†é˜æ¼”å‡º</button>
                    <button class="btn btn-rest" onclick="startRest()">Take Five ( 5 åˆ†é˜ä¼‘æ¯ )</button>
                </div>
                <div id="working-btns" style="display:none;">
                    <button class="btn btn-success" onclick="finishWork(true)">æ»¿å ‚å½©ï¼(ææ—©çµç®—)</button>
                    <button class="btn btn-danger" onclick="finishWork(false)">æ¼”å‡ºç¿»è»Šï¼(æ”¾æ£„ä»»å‹™)</button>
                </div>
                <div id="resting-btns" style="display:none;">
                    <button class="btn" onclick="finishRest()">ä¼‘æ¯å®Œç•¢ï¼Œå›åˆ°èˆå°</button>
                </div>
            </div>
        </div>
        
        <div class="jazz-window" style="width: 100%;">
            <h2>ğŸ“œ æ¼”å‡ºç´€éŒ„ (Gig Log)</h2>
            <div class="history-board" id="history-list"></div>
            <div class="clear-all-btn">
                <button class="btn-small btn-delete" onclick="clearAllHistory()">ğŸ”¥ ç‡’æ¯€å”±ç‰‡ç´€éŒ„</button>
            </div>
        </div>
    </div>

    <script>
        function handleCredentialResponse(response) {
            const responsePayload = decodeJwtResponse(response.credential);
            document.getElementById('player-name').innerText = responsePayload.name;
            document.getElementById('player-avatar').src = responsePayload.picture;
            document.getElementById('player-profile-ui').style.display = 'flex';
            document.querySelector('.g_id_signin').style.display = 'none';
        }
        function decodeJwtResponse(token) {
            let base64Url = token.split('.')[1];
            let base64 = base64Url.replace(/-/g, '+').replace(/_/g, '/');
            let jsonPayload = decodeURIComponent(window.atob(base64).split('').map(function(c) { return '%' + ('00' + c.charCodeAt(0).toString(16)).slice(-2); }).join(''));
            return JSON.parse(jsonPayload);
        }
        function signOut() {
            document.getElementById('player-profile-ui').style.display = 'none';
            document.querySelector('.g_id_signin').style.display = 'block';
        }

        function enterStage() {
            playTheLick();
            document.getElementById('start-intro-btn').style.display = 'none';
            document.getElementById('musician-img').style.left = '65%';
            setTimeout(() => { document.getElementById('musician-img').style.opacity = '0'; }, 2000);
            setTimeout(() => {
                document.getElementById('intro-screen').style.opacity = '0'; 
                setTimeout(() => {
                    document.getElementById('intro-screen').style.display = 'none'; 
                    const gameUI = document.getElementById('game-ui');
                    gameUI.style.display = 'flex';      
                    void gameUI.offsetWidth; 
                    gameUI.style.opacity = '1';
                }, 1000); 
            }, 2500);
        }

        const WORK_TIME = 25 * 60; const REST_TIME = 5 * 60;  
        let timerInterval; let timeLeft = WORK_TIME; let currentState = 'IDLE'; 
        let exp = parseInt(localStorage.getItem('jazzGroove')) || 0;
        let pomodoros = parseInt(localStorage.getItem('jazzGigs')) || 0;
        document.getElementById('exp-val').innerText = exp; document.getElementById('pomodoro-count').innerText = pomodoros;
        loadHistory(); updateDisplay();

        // === æ–°éŸ³æ•ˆå¼•æ“ï¼šç¶“å…¸è¿·å›  The Lick (D E F G E C D) ===
        function playTheLick() {
            const ctx = new (window.AudioContext || window.webkitAudioContext)();
            const now = ctx.currentTime;
            
            // æ—‹å¾‹é »ç‡ï¼šD4, E4, F4, G4, E4, C4, D4
            const notes = [
                { f: 293.66, d: 0.15 }, // D4
                { f: 329.63, d: 0.15 }, // E4
                { f: 349.23, d: 0.15 }, // F4
                { f: 392.00, d: 0.15 }, // G4
                { f: 329.63, d: 0.30 }, // E4 (é•·)
                { f: 261.63, d: 0.15 }, // C4
                { f: 293.66, d: 0.50 }  // D4 (çµå°¾)
            ];

            let startTime = now;
            notes.forEach((note) => {
                const osc = ctx.createOscillator();
                const gain = ctx.createGain();
                
                osc.type = 'triangle';
                osc.frequency.setValueAtTime(note.f, startTime);
                
                gain.gain.setValueAtTime(0, startTime);
                gain.gain.linearRampToValueAtTime(0.1, startTime + 0.05);
                gain.gain.linearRampToValueAtTime(0, startTime + note.d);
                
                osc.connect(gain);
                gain.connect(ctx.destination);
                
                osc.start(startTime);
                osc.stop(startTime + note.d);
                
                startTime += note.d;
            });
        }

        function updateDisplay() {
            let m = Math.floor(timeLeft / 60); let s = timeLeft % 60;
            document.getElementById('timer-display').innerText = (m < 10 ? '0' + m : m) + ':' + (s < 10 ? '0' + s : s);
        }

        function switchUI(state) {
            document.getElementById('idle-btns').style.display = (state === 'IDLE') ? 'block' : 'none';
            document.getElementById('working-btns').style.display = (state === 'WORKING') ? 'block' : 'none';
            document.getElementById('resting-btns').style.display = (state === 'RESTING') ? 'block' : 'none';
            const scrollUI = document.getElementById('scroll-ui');
            if (state === 'WORKING' || state === 'RESTING') { scrollUI.style.opacity = '0.4'; scrollUI.style.pointerEvents = 'none'; } 
            else { scrollUI.style.opacity = '1'; scrollUI.style.pointerEvents = 'auto'; }
        }

        function startWork() {
            const t = document.getElementById('quest-target').value;
            if(!t.trim()) { alert('ğŸ· å˜¿ï¼å…ˆå®šå¥½æ›²ç›®ç›®æ¨™å§ï¼'); return; }
            currentState = 'WORKING'; timeLeft = WORK_TIME; switchUI('WORKING'); runTimer('WORK');
        }

        function finishWork(isSuccess) {
            clearInterval(timerInterval);
            if (isSuccess) {
                playTheLick();
                setTimeout(() => {
                    let r = prompt("ğŸµ å®Œç¾å³èˆˆï¼å¯«ä¸‹ã€å¿ƒå¾—èˆ‡ä¸‹ä¸€å ´è¦åŠƒã€‘ï¼š");
                    if(!r) r = "æ¼”å‡ºæˆåŠŸã€‚";
                    exp += 150; pomodoros += 1;
                    localStorage.setItem('jazzGroove', exp); localStorage.setItem('jazzGigs', pomodoros);
                    document.getElementById('exp-val').innerText = exp; document.getElementById('pomodoro-count').innerText = pomodoros;
                    saveReport(document.getElementById('quest-target').value, document.getElementById('quest-problem').value, r);
                    document.querySelectorAll('#scroll-ui input[type="text"], textarea').forEach(el => el.value = '');
                    document.querySelectorAll('input[type="checkbox"]').forEach(el => el.checked = false);
                    resetToIdle();
                }, 100); 
            } else { if(confirm('è¦ä¸­æ–·é€™å ´æ¼”å‡ºå—ï¼Ÿ')) { resetToIdle(); } else { runTimer('WORK'); } }
        }

        function startRest() { currentState = 'RESTING'; timeLeft = REST_TIME; switchUI('RESTING'); runTimer('REST'); }
        function finishRest() { clearInterval(timerInterval); alert('ğŸ”” ä¼‘æ¯çµæŸã€‚'); resetToIdle(); }
        function runTimer(mode) {
            timerInterval = setInterval(() => { timeLeft--; updateDisplay();
                if(timeLeft <= 0) { clearInterval(timerInterval); if (mode === 'WORK') { finishWork(true); } else { playTheLick(); setTimeout(() => finishRest(), 100); } }
            }, 1000);
        }
        function resetToIdle() { currentState = 'IDLE'; timeLeft = WORK_TIME; updateDisplay(); switchUI('IDLE'); }

        function saveReport(t, p, r) {
            const now = new Date(); const timeString = `${now.getMonth()+1}/${now.getDate()} ${now.getHours().toString().padStart(2, '0')}:${now.getMinutes().toString().padStart(2, '0')}`;
            const record = { time: timeString, target: t, problem: p, report: r };
            let h = JSON.parse(localStorage.getItem('jazzHistory')) || []; h.unshift(record); 
            localStorage.setItem('jazzHistory', JSON.stringify(h)); loadHistory();
        }
        function deleteRecord(idx) {
            if(confirm('æŠ¹æ¶ˆé€™ç­†ç´€éŒ„ï¼Ÿ')) { let h = JSON.parse(localStorage.getItem('jazzHistory')) || []; h.splice(idx, 1); localStorage.setItem('jazzHistory', JSON.stringify(h)); loadHistory(); }
        }
        function clearAllHistory() { if(confirm('ğŸ”¥ ç¢ºå®šç‡’æ¯€å†’éšªä¹‹æ›¸ï¼Ÿ')) { localStorage.removeItem('jazzHistory'); loadHistory(); } }
        function loadHistory() {
            const list = document.getElementById('history-list'); list.innerHTML = '';
            let h = JSON.parse(localStorage.getItem('jazzHistory')) || [];
            if(h.length === 0) { list.innerHTML = '<div style="color:#aaa;">å†’éšªä¹‹æ›¸ç©ºç™½ä¸­...</div>'; return; }
            h.forEach((item, idx) => {
                const div = document.createElement('div'); div.className = 'history-item';
                div.innerHTML = `<div class="history-header"><span class="timestamp">[${item.time}]</span><button class="btn-small btn-delete" onclick="deleteRecord(${idx})">âœ–</button></div>
                    <div class="title">æ›²ç›®ï¼š${item.target}</div><div style="color:#55ffff;">ç“¶é ¸ï¼š${item.problem}</div><div style="color:#ffffff;">â” å¿ƒå¾—ï¼š${item.report}</div>`;
                list.appendChild(div);
            });
        }
    </script>
</body>
</html>
