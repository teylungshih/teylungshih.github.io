<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>çˆµå£«æ¨‚å¤§å¸«ä¹‹è·¯ v10.1 - è±å¯Œæ²™ç›’ç‰ˆ</title>
    <script src="https://accounts.google.com/gsi/client" async defer></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=DotGothic16&display=swap');
        
        body {
            font-family: 'DotGothic16', monospace; background-color: #000c18;
            color: #e0c097; margin: 0; padding: 20px; display: flex; flex-direction: column;
            align-items: center; min-height: 100vh; justify-content: center;
        }

        .jazz-window {
            background-color: #000000; border: 4px solid #d4af37; border-radius: 8px; padding: 20px;
            box-shadow: inset 0 0 0 2px #000, inset 0 0 0 4px #d4af37; 
            width: 100%; max-width: 850px; margin-bottom: 20px; box-sizing: border-box; position: relative;
        }

        /* 1. å…¥å£å‹•ç•« */
        .scene-container { position: relative; height: 160px; margin: 20px 0; border-bottom: 4px dashed #555; overflow: hidden; width: 100%; }
        #musician-img { position: absolute; left: 10%; bottom: 10px; transition: left 2.5s ease-in-out, opacity 0.5s ease; z-index: 2; }
        #stage-img { position: absolute; right: 15%; bottom: 10px; z-index: 1; }

        .btn-container { display: flex; justify-content: center; align-items: stretch; gap: 10px; margin-top: 20px; }
        .start-btn { background: transparent; color: #fff; border: 2px dashed #fff; padding: 15px 30px; font-family: 'DotGothic16'; font-size: 24px; cursor: pointer; animation: blink 1.5s infinite; flex-grow: 1; position: relative; overflow: hidden; }
        .quick-btn { background: #d4af37; color: #000; border: 2px solid #fff; width: 100px; font-family: 'DotGothic16'; font-size: 18px; cursor: pointer; display: flex; align-items: center; justify-content: center; font-weight: bold; transition: 0.2s; }
        #google-signin-overlay { position: absolute; top: 0; left: 0; width: 100%; height: 100%; opacity: 0.01; z-index: 10; cursor: pointer; }

        /* 2. ä¸–ç•Œåœ°åœ– */
        #world-map-picker { width: 100%; height: 350px; background-color: #001a33; position: relative; border: 2px solid #334455; margin-bottom: 15px; overflow: hidden; cursor: crosshair; }
        .map-grid-overlay { position: absolute; top: 0; left: 0; width: 100%; height: 100%; z-index: 2; pointer-events: none; background-image: linear-gradient(rgba(255,255,255,0.1) 1px, transparent 1px), linear-gradient(90deg, rgba(255,255,255,0.1) 1px, transparent 1px); background-size: 30px 30px; }
        .city-marker-new { position: absolute; width: 14px; height: 14px; background: #ff5555; border: 2px solid #fff; border-radius: 50%; transform: translate(-50%, -50%); box-shadow: 0 0 10px #ff0000; z-index: 3; animation: pulse 1.5s infinite; }
        .city-marker-saved { position: absolute; width: 16px; height: 16px; background: #d4af37; border: 2px solid #fff; border-radius: 50%; transform: translate(-50%, -50%); box-shadow: 0 0 10px #d4af37; z-index: 4; cursor: pointer; transition: 0.2s; }
        .city-marker-saved:hover { transform: translate(-50%, -50%) scale(1.5); background: #ffff00; }
        .marker-label { position: absolute; top: 15px; left: -20px; background: rgba(0,0,0,0.8); color: #fff; font-size: 12px; padding: 2px 6px; border-radius: 4px; white-space: nowrap; pointer-events: none; border: 1px solid #d4af37; }

        /* 3. é…’é¤¨åœ°åœ– */
        #tavern-map { width: 100%; height: 400px; background-color: #1a0f00; position: relative; border: 4px solid #4a3a2a; overflow: hidden; background-image: linear-gradient(45deg, #221500 25%, transparent 25%, transparent 75%, #221500 75%, #221500), linear-gradient(45deg, #221500 25%, transparent 25%, transparent 75%, #221500 75%, #221500); background-size: 60px 60px; background-position: 0 0, 30px 30px; }
        .tavern-zone { position: absolute; background: rgba(0,0,0,0.85); border: 2px solid #d4af37; color: #fff; text-align: center; min-width: 90px; transition: border-color 0.2s; user-select: none; }
        .tavern-zone:hover { border-color: #ffff00; }
        .drag-handle { background: #332211; color: #aaa; font-size: 10px; cursor: grab; padding: 2px; border-bottom: 1px dashed #d4af37; display: flex; justify-content: center; align-items: center; }
        .drag-handle:active { cursor: grabbing; background: #d4af37; color: #000; }
        .node-content { padding: 8px 12px; cursor: pointer; }
        .node-content:hover { background: rgba(212,175,55,0.2); }

        /* 4. ç´°é …èˆ‡å·¥ä½œå€ */
        .subtask-item { background: #111; border: 1px dashed #555; padding: 10px; margin-bottom: 10px; display: flex; justify-content: space-between; align-items: center; }
        #timer-display, #rest-timer-display { font-size: 80px; text-align: center; color: #fff; margin: 10px 0; letter-spacing: 5px; }
        
        /* å´å°å‚™å¿˜éŒ„ */
        #parking-lot-container { display: none; margin-top: 20px; border-top: 2px dashed #444; padding-top: 15px; }

        /* é€šç”¨å…ƒä»¶ */
        .btn { background: #000; color: #fff; border: 2px solid #fff; padding: 12px; cursor: pointer; width: 100%; margin-top: 10px; font-family: 'DotGothic16'; }
        .btn:hover { border-color: #ffff00; color: #ffff00; }
        .btn-small { background: transparent; color: #d4af37; border: 1px solid #d4af37; padding: 5px 10px; cursor: pointer; font-family: 'DotGothic16'; }
        .btn-small:hover { background: #d4af37; color: #000; }
        .input-group { margin-bottom: 15px; text-align: left; }
        input, select, textarea { width: 100%; background: #111; color: #fff; border: 1px solid #444; padding: 8px; box-sizing: border-box; font-family: 'DotGothic16'; }
        
        .page { display: none; }
        .active { display: block; }
        @keyframes pulse { 0%, 100% { transform: translate(-50%, -50%) scale(1); } 50% { transform: translate(-50%, -50%) scale(1.3); } }
        @keyframes blink { 0%, 100% { opacity: 1; } 50% { opacity: 0.4; } }
    </style>
</head>
<body>

    <div id="intro-screen" class="jazz-window page active">
        <h1 style="color: #ffff00;">THE JAZZ JOURNEY<br><span style="font-size: 24px; color: #888;">çˆµå£«æ¨‚å¤§å¸«ä¹‹è·¯</span></h1>
        <div id="g_id_onload" data-client_id="777879557726-kjm4c6nlt9ibpi5mjk0uuvuqja3uisf1.apps.googleusercontent.com" data-callback="handleCredentialResponse"></div>
        <div class="scene-container">
            <svg id="musician-img" viewBox="0 0 32 32" width="80" height="80"><rect x="12" y="14" width="8" height="10" fill="#222"/><rect x="11" y="4" width="10" height="10" fill="#4d3319"/><rect x="18" y="12" width="12" height="2" fill="#d4af37"/><rect x="12" y="24" width="3" height="6" fill="#111"/><rect x="17" y="24" width="3" height="6" fill="#111"/></svg>
            <svg id="stage-img" viewBox="0 0 40 40" width="100" height="100"><rect x="18" y="10" width="4" height="30" fill="#555"/><circle cx="20" cy="8" r="4" fill="#aaa"/></svg>
        </div>
        <div class="btn-container">
            <button class="start-btn">â–¶ å·¡æ¼”é–‹å§‹<div id="google-signin-overlay"><div class="g_id_signin" data-type="standard"></div></div></button>
            <button class="quick-btn" onclick="fastEnter()">ç›´æ¥<br>æ¼”å‡º</button>
        </div>
    </div>

    <div id="tour-setup" class="jazz-window page">
        <h2>ğŸ—ºï¸ 1. ä¸–ç•Œç‰ˆåœ–ï¼šè¦åŠƒæˆ–æ¥çºŒå·¡æ¼”</h2>
        <div id="world-map-picker" onclick="markNewLocation(event)">
            <svg viewBox="0 0 800 400" preserveAspectRatio="none" style="position:absolute; top:0; left:0; width:100%; height:100%; z-index:1; opacity: 0.8;"><path d="M 50,50 L 250,50 L 300,150 L 200,200 L 150,300 L 80,250 Z" fill="#2d4a3e" stroke="#3d6a4e" stroke-width="2"/><path d="M 220,220 L 320,200 L 280,380 L 240,380 Z" fill="#2d4a3e" stroke="#3d6a4e" stroke-width="2"/><path d="M 380,50 L 750,50 L 750,200 L 650,280 L 500,200 L 400,150 Z" fill="#2d4a3e" stroke="#3d6a4e" stroke-width="2"/><path d="M 380,180 L 500,180 L 450,350 L 380,280 Z" fill="#2d4a3e" stroke="#3d6a4e" stroke-width="2"/><path d="M 680,300 L 780,280 L 750,380 L 650,350 Z" fill="#2d4a3e" stroke="#3d6a4e" stroke-width="2"/></svg>
            <div class="map-grid-overlay"></div>
            <div style="position: absolute; top: 10px; left: 10px; color: #ffff00; font-size: 12px; z-index: 5; pointer-events: none; background:rgba(0,0,0,0.5); padding:5px;">ğŸ’¡ é»æ“Šã€Œé‡‘è‰²æ˜Ÿæ˜Ÿã€é€²å…¥å°ˆæ¡ˆï¼Œæˆ–ã€Œç©ºç™½é™¸åœ°ã€å»ºç«‹æ–°æ“šé»ã€‚</div>
        </div>
        <div style="border: 2px dashed #334455; padding: 15px; background: #000c18;">
            <h3 style="margin-top:0; color:#55ffff;">âœš å»ºç«‹æ–°å·¡æ¼”æ“šé»</h3>
            <div class="input-group"><label>å·¡æ¼”å°ˆæ¡ˆåç¨±ï¼š</label><input type="text" id="tour-name-v9"></div>
            <div class="input-group"><label>æ–°æ“šé»åº§æ¨™ï¼š</label><input type="text" id="tour-loc" readonly style="color: #ff5555;"></div>
            <button class="btn" onclick="createNewTour()" style="background:#d4af37; color:#000;">ç¢ºèªå»ºç«‹ä¸¦é€²å…¥é…’é¤¨é…ç½® â–¶</button>
        </div>
    </div>

    <div id="pub-setup" class="jazz-window page">
        <h2 id="pub-title">ğŸº 2. é…’é¤¨æ“šé»é…ç½®</h2>
        <div id="tavern-map"></div>
        <div style="margin-top:20px; background:#111; padding:15px; border:1px solid #333;">
            <div style="display:flex; gap:5px; flex-wrap:wrap;">
                <input type="text" id="category-input" placeholder="å¤§é …ç›®åç¨±..." style="flex:2; min-width:150px;">
                
                <select id="category-icon" style="flex:1; min-width:130px;">
                    <optgroup label="æ¨‚å™¨ (Instruments)">
                        <option value="ğŸ·">ğŸ· è–©å…‹æ–¯é¢¨</option>
                        <option value="ğŸº">ğŸº å°è™Ÿ</option>
                        <option value="ğŸ¸">ğŸ¸ å‰ä»–</option>
                        <option value="ğŸ¹">ğŸ¹ é‹¼ç´</option>
                        <option value="ğŸ¥">ğŸ¥ çˆµå£«é¼“</option>
                        <option value="ğŸ¤">ğŸ¤ éº¥å…‹é¢¨</option>
                        <option value="ğŸ»">ğŸ» ä½éŸ³æç´</option>
                    </optgroup>
                    <optgroup label="å®¶å…·èˆ‡è¨­å‚™ (Gear)">
                        <option value="ğŸ›‹ï¸">ğŸ›‹ï¸ å¾©å¤æ²™ç™¼</option>
                        <option value="ğŸª‘">ğŸª‘ é«˜è…³æ¤…</option>
                        <option value="ğŸ“»">ğŸ“» æ”¶éŸ³æ©Ÿ</option>
                        <option value="ğŸ’¡">ğŸ’¡ èšå…‰ç‡ˆ</option>
                        <option value="ğŸ•°ï¸">ğŸ•°ï¸ è€æ™‚é˜</option>
                        <option value="â˜ï¸">â˜ï¸ å¾©å¤é›»è©±</option>
                        <option value="ğŸ—„ï¸">ğŸ—„ï¸ æª”æ¡ˆæ«ƒ</option>
                    </optgroup>
                    <optgroup label="é…’æ°´èˆ‡é¤é£² (Drinks)">
                        <option value="ğŸ¥ƒ">ğŸ¥ƒ å¨å£«å¿Œ</option>
                        <option value="ğŸº">ğŸº ç²¾é‡€å•¤é…’</option>
                        <option value="ğŸ·">ğŸ· ç´…é…’</option>
                        <option value="ğŸ¸">ğŸ¸ é¦¬ä¸å°¼</option>
                        <option value="â˜•">â˜• é»‘å’–å•¡</option>
                        <option value="ğŸ½ï¸">ğŸ½ï¸ ä¸‹é…’èœ</option>
                    </optgroup>
                    <optgroup label="æ°£æ°› (Vibe)">
                        <option value="ğŸ¶">ğŸ¶ æ¼‚æµ®éŸ³ç¬¦</option>
                        <option value="âœ¨">âœ¨ éˆæ„Ÿç«èŠ±</option>
                        <option value="ğŸ”¥">ğŸ”¥ ç†±çƒˆè¨è«–</option>
                    </optgroup>
                </select>

                <select id="category-zone" style="flex:1; min-width:100px;">
                    <option value="èˆå° Stage">èˆå°</option>
                    <option value="å§æª¯ Bar">å§æª¯</option>
                    <option value="é‹¼ç´å€ Piano">é‹¼ç´å€</option>
                    <option value="è§€çœ¾å¸­ Lounge">è§€çœ¾å¸­</option>
                    <option value="å¾Œå° Backstage">å¾Œå°</option>
                    <option value="å…¥å£ Entrance">å…¥å£</option>
                </select>
                <button onclick="addCategory()" class="btn" style="flex:1; margin-top:0; background:#d4af37; color:#000;">æ”¾ç½®</button>
            </div>
        </div>
        <button class="btn" onclick="showWorldMap()">è¿”å›ä¸–ç•Œé¸å€</button>
    </div>

    <div id="detail-setup" class="jazz-window page">
        <h2 id="category-title" style="color:#55ffff;">ğŸ“Œ ç´°é …å»ºç½®å€</h2>
        <div style="background:#111; padding:15px; border:1px solid #333; margin-bottom:20px;">
            <label style="color:#d4af37;">æ–°å¢å·¥ä½œç´°é …ï¼š</label>
            <input type="text" id="subtask-name" placeholder="ç´°é …åç¨± (ä¾‹: æ’°å¯«ç¬¬ä¸€æ®µè‰ç¨¿)" style="margin-bottom:10px;">
            <button class="btn" onclick="addSubtask()" style="border-color:#55ffff; color:#55ffff; margin-top:0;">+ åŠ å…¥ç´°é …æ¸…å–®</button>
        </div>
        <h3>ğŸ“œ ç›®å‰ç´°é …æ¸…å–®</h3>
        <div id="subtask-list-container" style="min-height: 100px;"></div>
        <button class="btn" onclick="showPage('pub-setup')">è¿”å›é…’é¤¨åœ°åœ–</button>
    </div>

    <div id="game-ui" class="jazz-window page">
        <h2 style="color:#ff5555;">ğŸ”´ LIVE RECORDING</h2>
        <div style="text-align:center; font-size:1.2em; color:#d4af37; margin-bottom:10px;">
            æ­£åœ¨æ¼”å¥ï¼š<span id="playing-subtask-name" style="color:#fff;"></span>
        </div>
        
        <div id="timer-display">25:00</div>
        
        <div id="parking-lot-container">
            <label style="color:#55ffff; font-size:14px;">ğŸ’­ å´å°å‚™å¿˜éŒ„ (éˆæ„Ÿåœè»Šå ´)ï¼š</label>
            <p style="font-size:10px; color:#888; margin:0 0 5px 0;">è…¦ä¸­çªç„¶å†’å‡ºèˆ‡ç•¶ä¸‹ç„¡é—œçš„é›œäº‹å…ˆä¸Ÿé€™ï¼Œæ¸…ç©ºå¤§è…¦ç¹¼çºŒæ¼”å¥ï¼</p>
            <textarea id="parking-lot-text" rows="3" placeholder="ä¾‹å¦‚ï¼šè¨˜å¾—å›ä¿¡çµ¦ä¸»è¾¦å–®ä½..."></textarea>
        </div>

        <div id="action-btns" style="display:flex; gap:10px; margin-top:20px;">
            <button class="btn" onclick="startTimer()" style="color:#ffff00; border-color:#ffff00;">ğŸ· Showtime! (é–‹å§‹è¨ˆæ™‚)</button>
            <button class="btn" onclick="showPage('detail-setup')" style="border-color:#888;">è¿”å›ç´°é …</button>
        </div>
        <div id="working-btns" style="display:none; margin-top:20px;">
            <button class="btn" onclick="endPerformance()" style="color:#ffff00; border-color:#ffff00;">æ»¿å ‚å½©ï¼(é€²å…¥çµç®—)</button>
            <button class="btn" onclick="showPage('detail-setup')" style="color:#ff5555; border-color:#ff5555;">æ”¾æ£„æœ¬æ¬¡æ¼”å‡º (è¿”å›)</button>
        </div>
    </div>

    <div id="report-ui" class="jazz-window page">
        <h2 style="color:#d4af37;">ğŸ“ æ¼”å‡ºç‹€æ…‹å›å ± (Gig Report)</h2>
        <p style="text-align:center; color:#888; font-size:14px;">é€™äº›ç´€éŒ„æœªä¾†å°‡åŒæ­¥è‡³ä½ çš„å°ˆå±¬ Google Docs</p>
        
        <div class="input-group">
            <label>ğŸ· Groove ç‹€æ…‹ (å°ˆæ³¨åº¦è©•åˆ†)ï¼š</label>
            <select id="report-groove">
                <option value="In the Pocket">ğŸ”¥ğŸ”¥ğŸ”¥ In the Pocket (å®Œç¾å¿ƒæµ)</option>
                <option value="Keeping Time" selected>ğŸ”¥ğŸ”¥ Keeping Time (ç©©æ‰ç©©æ‰“)</option>
                <option value="Dragging">ğŸ”¥ Dragging (é »é »æ‰æ‹)</option>
            </select>
        </div>
        <div class="input-group">
            <label>æ¨é€²ç‹€æ…‹ï¼š</label>
            <select id="report-progress">
                <option value="âœ… ä»»å‹™å®Œçµ">âœ… é€™é¦–æ›²å­æå®šäº† (ä»»å‹™å®Œçµ)</option>
                <option value="ğŸ” éœ€å®‰å¯" selected>ğŸ” é‚„éœ€å®‰å¯ (éœ€è¦å†ä¾†ä¸€å€‹ç•ªèŒ„é˜)</option>
            </select>
        </div>
        <div class="input-group">
            <label>æ¼”å‡ºç­†è¨˜ (Session Notes)ï¼š</label>
            <textarea id="report-notes" rows="4" placeholder="è¨˜éŒ„é€™æ¬¡ç”¢å‡ºäº†ä»€éº¼ï¼Ÿé‡åˆ°ä»€éº¼ç“¶é ¸ï¼Ÿ..."></textarea>
        </div>
        
        <button class="btn" onclick="saveReportAndRest()" style="color:#55ffff; border-color:#55ffff;">å„²å­˜ç´€éŒ„ä¸¦é€²å…¥ â˜• Take Five (ä¼‘æ¯)</button>
        <button class="btn" onclick="saveReportAndReturn()" style="border-color:#888;">å„²å­˜ä¸¦è¿”å›ç´°é …æ¸…å–®</button>
    </div>

    <div id="rest-ui" class="jazz-window page">
        <h2 style="color:#55ffff;">â˜• TAKE FIVE</h2>
        <p style="text-align:center; color:#ccc;">å–æ¯æ°´ï¼Œä¼¸å€‹æ‡¶è…°ã€‚å¤§å¸«ä¹Ÿéœ€è¦è®“è‚Œè‚‰æ”¾é¬†ã€‚</p>
        <div id="rest-timer-display" style="color:#55ffff;">05:00</div>
        <button class="btn" onclick="endRestEarly()" style="border-color:#888;">ç²¾ç¥ç™¾å€ï¼ææ—©è¿”å›èˆå°</button>
    </div>

    <script>
        let tours = JSON.parse(localStorage.getItem('jazzToursData')) || [];
        let currentTourIndex = -1; let currentCatIndex = -1; let tempLoc = null;
        let timerInterval, timeLeft = 25 * 60;
        let restInterval, restTimeLeft = 5 * 60;

        function playTheLick() { try { const ctx = new (window.AudioContext || window.webkitAudioContext)(); const now = ctx.currentTime; const notes = [{f:293.66,d:0.15},{f:329.63,d:0.15},{f:349.23,d:0.15},{f:392,d:0.15},{f:329.63,d:0.3},{f:261.63,d:0.15},{f:293.66,d:0.5}]; let start = now; notes.forEach(n => { const o = ctx.createOscillator(); const g = ctx.createGain(); o.type = 'triangle'; o.frequency.setValueAtTime(n.f, start); g.gain.setValueAtTime(0, start); g.gain.linearRampToValueAtTime(0.1, start+0.05); g.gain.linearRampToValueAtTime(0, start+n.d); o.connect(g); g.connect(ctx.destination); o.start(start); o.stop(start+n.d); start += n.d; }); } catch(e) {} }
        
        function handleCredentialResponse() { playTheLick(); document.querySelector('.btn-container').style.display = 'none'; document.getElementById('musician-img').style.left = '65%'; setTimeout(() => { document.getElementById('musician-img').style.opacity = '0'; setTimeout(() => showWorldMap(), 500); }, 2500); }
        function fastEnter() { playTheLick(); showWorldMap(); }
        function showPage(id) { document.querySelectorAll('.page').forEach(p => p.classList.remove('active')); document.getElementById(id).classList.add('active'); }

        /* åœ°åœ–é‚è¼¯ */
        function showWorldMap() { showPage('tour-setup'); renderWorldMap(); }
        function renderWorldMap() { const map = document.getElementById('world-map-picker'); document.querySelectorAll('.city-marker-saved').forEach(e => e.remove()); tours.forEach((tour, i) => { const m = document.createElement('div'); m.className = 'city-marker-saved'; m.style.left = tour.loc.x + '%'; m.style.top = tour.loc.y + '%'; m.innerHTML = `<span class="marker-label">${tour.name}</span>`; m.onclick = (e) => { e.stopPropagation(); enterExistingTour(i); }; map.appendChild(m); }); }
        function markNewLocation(e) { const map = document.getElementById('world-map-picker'); const rect = map.getBoundingClientRect(); const x = ((e.clientX - rect.left) / rect.width) * 100, y = ((e.clientY - rect.top) / rect.height) * 100; let m = document.getElementById('new-city-marker'); if(!m) { m = document.createElement('div'); m.id = 'new-city-marker'; m.className = 'city-marker-new'; map.appendChild(m); } m.style.left = x + '%'; m.style.top = y + '%'; tempLoc = { x: x.toFixed(1), y: y.toFixed(1) }; document.getElementById('tour-loc').value = `LAT:${tempLoc.y} / LON:${tempLoc.x}`; }
        function createNewTour() { const name = document.getElementById('tour-name-v9').value; if(!name || !tempLoc) return alert("è«‹é»æ“Šåœ°åœ–ä¸¦å¡«å¯«åç¨±ï¼"); tours.push({ name: name, loc: tempLoc, categories: [] }); currentTourIndex = tours.length - 1; saveData(); openTavern(); }
        function enterExistingTour(index) { currentTourIndex = index; openTavern(); }

        /* é…’é¤¨é‚è¼¯ */
        function openTavern() { document.getElementById('pub-title').innerText = `ğŸº ${tours[currentTourIndex].name} - é…’é¤¨å…§éƒ¨`; showPage('pub-setup'); renderTavernNodes(); }
        function addCategory() { const name = document.getElementById('category-input').value; const icon = document.getElementById('category-icon').value; const zone = document.getElementById('category-zone').value; if(!name) return; tours[currentTourIndex].categories.push({ name, icon, zone, x: 40+Math.random()*20, y: 40+Math.random()*20, subtasks: [] }); saveData(); renderTavernNodes(); document.getElementById('category-input').value = ''; }
        function renderTavernNodes() { const map = document.getElementById('tavern-map'); map.innerHTML = ''; tours[currentTourIndex].categories.forEach((cat, i) => { const node = document.createElement('div'); node.className = 'tavern-zone'; node.style.left = cat.x + '%'; node.style.top = cat.y + '%'; node.innerHTML = `<div class="drag-handle">ğŸ–ï¸</div><div class="node-content" onclick="openCategoryDetail(${i})"><span style="font-size:24px;">${cat.icon||'ğŸµ'}</span><br>${cat.name}</div>`; map.appendChild(node); makeDraggable(node, i); }); }
        function makeDraggable(el, idx) { let p1=0, p2=0, p3=0, p4=0; el.querySelector('.drag-handle').onmousedown = dragMouseDown; function dragMouseDown(e) { e.preventDefault(); p3 = e.clientX; p4 = e.clientY; document.onmouseup = closeDragElement; document.onmousemove = elementDrag; } function elementDrag(e) { e.preventDefault(); p1 = p3 - e.clientX; p2 = p4 - e.clientY; p3 = e.clientX; p4 = e.clientY; el.style.top = (el.offsetTop - p2) + "px"; el.style.left = (el.offsetLeft - p1) + "px"; } function closeDragElement() { document.onmouseup = null; document.onmousemove = null; const parent = document.getElementById('tavern-map'); tours[currentTourIndex].categories[idx].x = (el.offsetLeft / parent.offsetWidth) * 100; tours[currentTourIndex].categories[idx].y = (el.offsetTop / parent.offsetHeight) * 100; saveData(); } }

        /* ç´°é …é‚è¼¯ */
        function openCategoryDetail(index) { currentCatIndex = index; const cat = tours[currentTourIndex].categories[index]; document.getElementById('category-title').innerText = `ğŸ“Œ ${cat.icon||''} ${cat.name} (${cat.zone})`; renderSubtaskList(); showPage('detail-setup'); }
        function addSubtask() { const name = document.getElementById('subtask-name').value; if(!name) return alert("è«‹è¼¸å…¥åç¨±"); tours[currentTourIndex].categories[currentCatIndex].subtasks.push({ name: name, imp: 'â­â­â­' }); saveData(); renderSubtaskList(); document.getElementById('subtask-name').value = ''; }
        function renderSubtaskList() { const container = document.getElementById('subtask-list-container'); container.innerHTML = ''; const tasks = tours[currentTourIndex].categories[currentCatIndex].subtasks; if(tasks.length===0){ container.innerHTML='<div style="color:#666;">ç„¡ç´°é …</div>'; return;} tasks.forEach((t, i) => { const div = document.createElement('div'); div.className = 'subtask-item'; div.innerHTML = `<div><b style="color:#fff;">${t.name}</b></div><button class="btn-small" onclick="enterGameUI(${i})">â–¶ æ¼”å‡º</button>`; container.appendChild(div); }); }

        /* å·¥ä½œå€èˆ‡çµç®—ç³»çµ±é‚è¼¯ */
        function enterGameUI(subIndex) {
            document.getElementById('playing-subtask-name').innerText = tours[currentTourIndex].categories[currentCatIndex].subtasks[subIndex].name;
            clearInterval(timerInterval); timeLeft = 25 * 60; updateTimerDisplay();
            document.getElementById('action-btns').style.display = 'flex'; 
            document.getElementById('working-btns').style.display = 'none';
            document.getElementById('parking-lot-container').style.display = 'none';
            document.getElementById('parking-lot-text').value = '';
            showPage('game-ui');
        }

        function startTimer() { 
            playTheLick();
            document.getElementById('action-btns').style.display = 'none'; 
            document.getElementById('working-btns').style.display = 'flex'; 
            document.getElementById('parking-lot-container').style.display = 'block';
            timerInterval = setInterval(() => { timeLeft--; updateTimerDisplay(); if(timeLeft <= 0) endPerformance(); }, 1000); 
        }
        
        function endPerformance() {
            clearInterval(timerInterval); playTheLick();
            const parkingNotes = document.getElementById('parking-lot-text').value;
            const reportNotes = document.getElementById('report-notes');
            if(parkingNotes.trim() !== '') { reportNotes.value = `ã€å´å°éˆæ„Ÿã€‘\n${parkingNotes}\n\nã€æ¼”å‡ºå¿ƒå¾—ã€‘\n`; } else { reportNotes.value = ''; }
            showPage('report-ui');
        }

        function saveReportData() {
            const reportData = {
                time: new Date().toLocaleString(), tourName: tours[currentTourIndex].name, categoryZone: tours[currentTourIndex].categories[currentCatIndex].zone,
                task: document.getElementById('playing-subtask-name').innerText, groove: document.getElementById('report-groove').value,
                progress: document.getElementById('report-progress').value, notes: document.getElementById('report-notes').value
            };
            let h = JSON.parse(localStorage.getItem('jazzGigHistory')) || []; h.unshift(reportData); localStorage.setItem('jazzGigHistory', JSON.stringify(h));
        }

        function saveReportAndReturn() { saveReportData(); showPage('detail-setup'); }
        function saveReportAndRest() {
            saveReportData(); restTimeLeft = 5 * 60; updateRestDisplay(); showPage('rest-ui');
            restInterval = setInterval(() => { restTimeLeft--; updateRestDisplay(); if(restTimeLeft <= 0) { clearInterval(restInterval); playTheLick(); alert("Take Five çµæŸï¼"); showPage('detail-setup'); } }, 1000);
        }
        function endRestEarly() { clearInterval(restInterval); showPage('detail-setup'); }
        function updateTimerDisplay() { let m = Math.floor(timeLeft / 60), s = timeLeft % 60; document.getElementById('timer-display').innerText = `${m<10?'0'+m:m}:${s<10?'0'+s:s}`; }
        function updateRestDisplay() { let m = Math.floor(restTimeLeft / 60), s = restTimeLeft % 60; document.getElementById('rest-timer-display').innerText = `${m<10?'0'+m:m}:${s<10?'0'+s:s}`; }
        function saveData() { localStorage.setItem('jazzToursData', JSON.stringify(tours)); }
        function decodeJwtResponse(t) { return JSON.parse(decodeURIComponent(window.atob(t.split('.')[1].replace(/-/g, '+').replace(/_/g, '/')).split('').map(c => '%' + ('00' + c.charCodeAt(0).toString(16)).slice(-2)).join(''))); }
    </script>
</body>
</html>
