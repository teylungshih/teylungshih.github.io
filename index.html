<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>çˆµå£«æ¨‚å¤§å¸«ä¹‹è·¯ - The Jazz Journey v7.1</title>
    
    <script src="https://accounts.google.com/gsi/client" async defer></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=DotGothic16&display=swap');
        
        body {
            font-family: 'DotGothic16', monospace; background-color: #000c18;
            background-image: radial-gradient(circle at 50% 30%, #0f2040 0%, #000c18 70%);
            color: #e0c097; margin: 0; padding: 20px; display: flex; flex-direction: column;
            align-items: center; min-height: 100vh; justify-content: center;
        }
        
        .jazz-window {
            background-color: #000000; border: 4px solid #d4af37; border-radius: 8px; padding: 20px;
            box-shadow: inset 0 0 0 2px #000, inset 0 0 0 4px #d4af37; 
            width: 100%; max-width: 800px; margin-bottom: 20px; box-sizing: border-box; position: relative;
        }

        h1, h2, h3 { margin-top: 0; text-align: center; color: #ffff00; text-shadow: 2px 2px 0px #aa5500; }
        
        /* æœˆæ›†å‚³é€é–€ */
        .calendar-portal {
            position: absolute; right: -80px; top: 100px; width: 60px; text-align: center; cursor: pointer; text-decoration: none;
        }
        .calendar-icon { width: 50px; height: 50px; background: #fff; border: 3px solid #d4af37; border-radius: 4px; position: relative; margin: 0 auto; overflow: hidden; }
        .calendar-icon::before { content: ""; position: absolute; top: 0; left: 0; right: 0; height: 12px; background: #ff5555; border-bottom: 2px solid #d4af37; }
        #calendar-date-text { position: absolute; width: 100%; top: 15px; left: 0; font-size: 22px; color: #000; font-weight: bold; text-align: center; }

        /* å…¥å£ç•«é¢ */
        #intro-screen { text-align: center; width: 100%; max-width: 600px; }
        .scene-container { position: relative; height: 160px; margin: 40px 0; border-bottom: 4px dashed #555; overflow: hidden; }
        #musician-img { position: absolute; left: 10%; bottom: 10px; transition: left 2.5s ease-in-out, opacity 0.5s ease; z-index: 2; }
        #stage-img { position: absolute; right: 15%; bottom: 10px; z-index: 1; }
        
        .btn-container { display: flex; justify-content: center; gap: 10px; margin-top: 20px; }
        .start-btn { 
            background-color: transparent; color: #fff; border: 2px dashed #fff; padding: 15px 30px; 
            font-family: 'DotGothic16', monospace; font-size: 24px; cursor: pointer; 
            animation: blink 1.5s infinite; flex-grow: 1; position: relative; 
        }
        .quick-btn { 
            background-color: #d4af37; color: #000; border: 2px solid #fff; width: 100px; 
            font-family: 'DotGothic16', monospace; cursor: pointer; font-weight: bold; 
        }
        #google-signin-overlay { position: absolute; top: 0; left: 0; width: 100%; height: 100%; opacity: 0.01; z-index: 10; cursor: pointer; }

        @keyframes blink { 0%, 100% { opacity: 1; } 50% { opacity: 0.4; } }

        /* å°ˆæ¡ˆé¸æ“‡/å»ºç½®ç•«é¢ */
        #tour-manager-ui, #tour-builder-ui { display: none; }
        .tour-item { 
            background: #111; border: 2px solid #333; padding: 15px; margin-bottom: 10px; 
            cursor: pointer; transition: 0.2s; display: flex; justify-content: space-between; align-items: center;
        }
        .tour-item:hover { border-color: #d4af37; background: #1a1a1a; }

        /* å»ºç½®è¡¨æ ¼æ¨£å¼ */
        .task-row { 
            background: #111; border: 1px dashed #444; padding: 10px; margin-bottom: 10px;
            display: grid; grid-template-columns: 2fr 1.2fr 0.8fr 1fr 40px; gap: 8px; align-items: center;
        }
        input, select, textarea { 
            background: #000; color: #fff; border: 1px solid #333; padding: 5px; 
            font-family: 'DotGothic16', monospace; font-size: 16px; 
        }

        /* ä¸»ç•«é¢ */
        #game-ui { display: none; opacity: 0; transition: opacity 0.8s; }
        .status-bar { display: flex; justify-content: space-around; font-size: 1.2em; border-bottom: 2px dashed #fff; padding-bottom: 10px; margin-bottom: 15px; }
        .btn { background: #000; color: #fff; border: 2px solid #fff; padding: 12px; cursor: pointer; width: 100%; margin-top: 10px; text-align: left; font-family: 'DotGothic16', monospace; }
        .btn:hover { border-color: #ffff00; color: #ffff00; }
        #timer-display { font-size: 80px; text-align: center; color: #fff; margin: 10px 0; letter-spacing: 5px; }
    </style>
</head>
<body>

    <div id="intro-screen" class="jazz-window">
        <h1>THE JAZZ JOURNEY<br><span style="font-size: 24px; color: #888;">çˆµå£«æ¨‚å¤§å¸«ä¹‹è·¯</span></h1>
        <div id="g_id_onload" data-client_id="777879557726-kjm4c6nlt9ibpi5mjk0uuvuqja3uisf1.apps.googleusercontent.com" data-callback="handleCredentialResponse"></div>
        <div class="scene-container">
            <svg id="musician-img" viewBox="0 0 32 32" width="80" height="80">
                <rect x="12" y="14" width="8" height="10" fill="#222" /><rect x="11" y="4" width="10" height="10" fill="#4d3319" /><rect x="12" y="10" width="8" height="2" fill="#000" /><rect x="18" y="12" width="12" height="2" fill="#d4af37" /><rect x="28" y="10" width="2" height="6" fill="#d4af37" /><rect x="12" y="24" width="3" height="6" fill="#111" /><rect x="17" y="24" width="3" height="6" fill="#111" />
            </svg>
            <svg id="stage-img" viewBox="0 0 40 40" width="100" height="100">
                <rect x="18" y="10" width="4" height="30" fill="#555" /><circle cx="20" cy="8" r="4" fill="#aaa" /><rect x="12" y="38" width="16" height="2" fill="#333" />
            </svg>
        </div>
        <div class="btn-container">
            <button class="start-btn">â–¶ ä¸‹é”æ¼”å‡ºæŒ‡ä»¤
                <div id="google-signin-overlay"><div class="g_id_signin" data-type="standard" data-width="400"></div></div>
            </button>
            <button class="quick-btn" onclick="fastEnter()">ç›´æ¥<br>é–‹æ¼”</button>
        </div>
    </div>

    <div id="tour-manager-ui" class="jazz-window">
        <h2>ğŸ“œ å·¡æ¼”åœ°åœ– (Tour Map)</h2>
        <div id="tour-list-container" style="max-height: 300px; overflow-y: auto; margin-bottom: 20px;"></div>
        <button class="btn" onclick="showTourBuilder()" style="border-color: #d4af37; color: #d4af37;">+ ç±Œå‚™æ–°çš„å·¡æ¼”å°ˆæ¡ˆ</button>
    </div>

    <div id="tour-builder-ui" class="jazz-window">
        <h2>ğŸ—ºï¸ ç±Œå‚™æ–°å·¡æ¼”</h2>
        <label>ğŸ¤ å·¡æ¼”å°ˆæ¡ˆåç¨±ï¼š</label>
        <input type="text" id="new-tour-name" placeholder="ä¾‹å¦‚ï¼š2026 èŠ±è“®ç¾¤å‹Ÿè¨ˆç•«" style="width: 100%; margin-bottom: 20px;">
        <h3>æ›²ç›®æ¸…å–® (å·¥ä½œç´°é …)</h3>
        <div id="builder-task-container"></div>
        <button class="btn-small" onclick="addTaskRow()" style="margin: 10px 0; color: #55ffff; background:none; border: 1px dashed #55ffff; cursor:pointer;">+ å¢åŠ ç´°é …</button>
        <div class="btn-container">
            <button class="btn" onclick="saveNewTour()" style="background: #d4af37; color: #000;">å®Œæˆå»ºç½®</button>
            <button class="btn" onclick="showTourManager()">å–æ¶ˆ</button>
        </div>
    </div>

    <div id="game-ui">
        <div class="jazz-window">
            <a href="https://afroisgood.github.io/" target="_blank" class="calendar-portal">
                <div class="calendar-icon"><div id="calendar-date-text">--</div></div>
                <span style="font-size: 10px; color:#d4af37;">JAZZ 365</span>
            </a>
            <div id="active-tour-info" style="color: #d4af37; font-size: 1.2em; border-bottom: 1px solid #333; padding-bottom: 5px; margin-bottom: 15px;">æ­£åœ¨å·¡æ¼”ï¼š<span id="current-tour-name">æœªé¸æ“‡</span></div>
            <div id="scroll-ui">
                <label>ğŸ¯ é¸æ“‡æ¼”å‡ºæ›²ç›® (Task)ï¼š</label>
                <select id="task-selector" style="width: 100%; margin-bottom: 15px;"></select>
                <div id="task-detail-info" style="font-size: 0.9em; color: #888; margin-bottom: 10px;"></div>
            </div>
            <div id="timer-display">25:00</div>
            <div id="action-buttons">
                <div id="idle-btns">
                    <button class="btn" onclick="startWork()" style="color:#ffff00; border-color:#ffff00;">ğŸ· Showtime! é–‹å§‹æ¼”å‡º</button>
                    <button class="btn" onclick="showTourManager()" style="border-color: #888;">åˆ‡æ›å·¡æ¼”å°ˆæ¡ˆ</button>
                </div>
                <div id="working-btns" style="display:none;">
                    <button class="btn" onclick="finishWork(true)" style="color:#ffff00; border-color:#ffff00;">æ»¿å ‚å½©ï¼(ææ—©çµæŸ)</button>
                    <button class="btn" onclick="finishWork(false)" style="color:#ff5555; border-color:#ff5555;">æ¼”å‡ºç¿»è»Š (æ”¾æ£„)</button>
                </div>
            </div>
        </div>
        <div class="jazz-window">
            <h2>ğŸ“œ æ¼”å‡ºç´€éŒ„</h2>
            <div id="history-list" style="max-height: 200px; overflow-y: auto;"></div>
        </div>
    </div>

    <script>
        // === å…¨åŸŸéŸ³æ•ˆå‡½æ•¸ï¼šç¶“å…¸ The Lick ===
        function playTheLick() {
            try {
                const ctx = new (window.AudioContext || window.webkitAudioContext)();
                const now = ctx.currentTime;
                // D4, E4, F4, G4, E4, C4, D4
                const notes = [
                    {f: 293.66, d: 0.15}, {f: 329.63, d: 0.15}, {f: 349.23, d: 0.15}, {f: 392.00, d: 0.15},
                    {f: 329.63, d: 0.30}, {f: 261.63, d: 0.15}, {f: 293.66, d: 0.50}
                ];
                let startTime = now;
                notes.forEach(note => {
                    const osc = ctx.createOscillator();
                    const gain = ctx.createGain();
                    osc.type = 'triangle';
                    osc.frequency.setValueAtTime(note.f, startTime);
                    gain.gain.setValueAtTime(0, startTime);
                    gain.gain.linearRampToValueAtTime(0.1, startTime + 0.05);
                    gain.gain.linearRampToValueAtTime(0, startTime + note.d);
                    osc.connect(gain); gain.connect(ctx.destination);
                    osc.start(startTime); osc.stop(startTime + note.d);
                    startTime += note.d;
                });
            } catch(e) { console.log("Audio Error:", e); }
        }

        let tours = JSON.parse(localStorage.getItem('jazzTours')) || [];
        let currentTourIndex = -1;
        let timerInterval, timeLeft = 25 * 60;

        document.getElementById('calendar-date-text').innerText = new Date().getDate();

        // ç™»å…¥èˆ‡é€²å ´ï¼šç¢ºä¿èª¿ç”¨éŸ³æ•ˆ
        function handleCredentialResponse(response) { 
            const payload = decodeJwtResponse(response.credential);
            playTheLick(); 
            enterStage(); 
        }
        
        function fastEnter() { 
            playTheLick(); 
            showTourManager(); 
        }

        function showTourManager() {
            document.getElementById('intro-screen').style.display = 'none';
            document.getElementById('tour-builder-ui').style.display = 'none';
            document.getElementById('game-ui').style.display = 'none';
            document.getElementById('tour-manager-ui').style.display = 'block';
            renderTourList();
        }

        function enterStage() {
            document.querySelector('.btn-container').style.display = 'none';
            document.getElementById('musician-img').style.left = '65%';
            setTimeout(() => { showTourManager(); }, 2500);
        }

        // å°ˆæ¡ˆç®¡ç†
        function renderTourList() {
            const container = document.getElementById('tour-list-container');
            container.innerHTML = tours.length ? '' : '<p style="text-align:center; color:#666;">å°šæœªæœ‰å·¡æ¼”è¨ˆç•«</p>';
            tours.forEach((tour, index) => {
                const div = document.createElement('div');
                div.className = 'tour-item';
                div.innerHTML = `<span>ğŸµ ${tour.name} (${tour.tasks.length} é¦–æ›²ç›®)</span><button onclick="deleteTour(event, ${index})" style="color:red; background:none; border:none; cursor:pointer; font-family:DotGothic16;">âœ–</button>`;
                div.onclick = () => selectTour(index);
                container.appendChild(div);
            });
        }

        function showTourBuilder() {
            document.getElementById('tour-manager-ui').style.display = 'none';
            document.getElementById('tour-builder-ui').style.display = 'block';
            document.getElementById('builder-task-container').innerHTML = '';
            document.getElementById('new-tour-name').value = '';
            addTaskRow();
        }

        function addTaskRow() {
            const container = document.getElementById('builder-task-container');
            const row = document.createElement('div');
            row.className = 'task-row';
            row.innerHTML = `
                <input type="text" placeholder="ç´°é …åç¨±" class="t-name">
                <input type="date" class="t-date">
                <select class="t-diff"><option value="1">â­</option><option value="2">â­â­</option><option value="3">â­â­â­</option><option value="4">â­â­â­â­</option><option value="5">â­â­â­â­â­</option></select>
                <select class="t-urg"><option value="æ…¢æ¿">æ…¢æ¿</option><option value="ä¸­æ¿">ä¸­æ¿</option><option value="æ€¥æ¿">æ€¥æ¿</option></select>
                <button onclick="this.parentElement.remove()" style="color:red; background:none; border:none; cursor:pointer;">âœ–</button>
            `;
            container.appendChild(row);
        }

        function saveNewTour() {
            const name = document.getElementById('new-tour-name').value;
            if(!name) return alert("è«‹è¼¸å…¥å·¡æ¼”åç¨±");
            const taskRows = document.querySelectorAll('.task-row');
            let tasks = [];
            taskRows.forEach(row => {
                const tName = row.querySelector('.t-name').value;
                if(tName) {
                    tasks.push({
                        name: tName,
                        date: row.querySelector('.t-date').value,
                        diff: row.querySelector('.t-diff').value,
                        urg: row.querySelector('.t-urg').value
                    });
                }
            });
            if(tasks.length === 0) return alert("è«‹è‡³å°‘å¢åŠ ä¸€å€‹æ¼”å‡ºç´°é …");
            tours.push({ name, tasks });
            localStorage.setItem('jazzTours', JSON.stringify(tours));
            showTourManager();
        }

        function deleteTour(e, index) {
            e.stopPropagation();
            if(confirm("ç¢ºå®šè¦ç‡’æ¯€é€™å ´å·¡æ¼”è¨ˆç•«å—ï¼Ÿ")) {
                tours.splice(index, 1);
                localStorage.setItem('jazzTours', JSON.stringify(tours));
                renderTourList();
            }
        }

        function selectTour(index) {
            currentTourIndex = index;
            const tour = tours[index];
            document.getElementById('tour-manager-ui').style.display = 'none';
            document.getElementById('game-ui').style.display = 'block';
            document.getElementById('game-ui').style.opacity = '1';
            document.getElementById('current-tour-name').innerText = tour.name;
            
            const selector = document.getElementById('task-selector');
            selector.innerHTML = '';
            tour.tasks.forEach((t, i) => {
                const opt = document.createElement('option');
                opt.value = i;
                opt.innerText = `${t.urg} | ${t.name} (â­${t.diff})`;
                selector.appendChild(opt);
            });
            updateTaskDetail();
            selector.onchange = updateTaskDetail;
        }

        function updateTaskDetail() {
            const task = tours[currentTourIndex].tasks[document.getElementById('task-selector').value];
            document.getElementById('task-detail-info').innerText = `æˆªæ­¢ï¼š${task.date || 'æœªè¨­å®š'} | é›£åº¦ï¼š${task.diff} æ˜Ÿ`;
        }

        // è¨ˆæ™‚å™¨é‚è¼¯
        function startWork() {
            document.getElementById('idle-btns').style.display = 'none';
            document.getElementById('working-btns').style.display = 'block';
            timerInterval = setInterval(() => {
                timeLeft--;
                updateDisplay();
                if(timeLeft <= 0) finishWork(true);
            }, 1000);
        }

        function finishWork(success) {
            clearInterval(timerInterval);
            if(success) {
                playTheLick();
                const task = tours[currentTourIndex].tasks[document.getElementById('task-selector').value];
                let report = prompt("é€™æ®µ Session çš„æ¼”å‡ºå¿ƒå¾—ï¼š");
                if(!report) report = "æ¼”å‡ºé †åˆ©å®Œæˆã€‚";
                saveRecord(task.name, report);
            }
            timeLeft = 25 * 60; updateDisplay();
            document.getElementById('idle-btns').style.display = 'block';
            document.getElementById('working-btns').style.display = 'none';
        }

        function updateDisplay() {
            let m = Math.floor(timeLeft / 60), s = timeLeft % 60;
            document.getElementById('timer-display').innerText = `${m<10?'0'+m:m}:${s<10?'0'+s:s}`;
        }

        function saveRecord(task, report) {
            let h = JSON.parse(localStorage.getItem('jazzHistory')) || [];
            h.unshift({ time: new Date().toLocaleString(), task, report });
            localStorage.setItem('jazzHistory', JSON.stringify(h));
            loadHistory();
        }

        function loadHistory() {
            const container = document.getElementById('history-list');
            container.innerHTML = '';
            const h = JSON.parse(localStorage.getItem('jazzHistory')) || [];
            h.forEach(item => {
                const div = document.createElement('div');
                div.style.borderBottom = "1px dashed #444"; div.style.padding = "10px 0";
                div.innerHTML = `<small style="color:#888;">${item.time}</small><br><b style="color:#ffff00;">${item.task}</b>: ${item.report}`;
                container.appendChild(div);
            });
        }

        function decodeJwtResponse(token) {
            let base64 = token.split('.')[1].replace(/-/g, '+').replace(/_/g, '/');
            return JSON.parse(decodeURIComponent(window.atob(base64).split('').map(c => '%' + ('00' + c.charCodeAt(0).toString(16)).slice(-2)).join('')));
        }

        loadHistory();
    </script>
</body>
</html>
